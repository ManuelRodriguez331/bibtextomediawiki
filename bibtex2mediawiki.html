<!doctype html>
<html> 
<head>
<meta charset="utf-8">
<title>Bibtex to mediawiki converter</title>
<script type="text/javascript">
/*
Bibtex to mediawiki converter

*/
// global variables  
var version=0.54
var Item = function(type,bibtex,wikisyntax) {
  this.type = type
  this.bibtex = bibtex
  this.wikisyntax = wikisyntax
}
var item = [
  new Item("header","@article","<ref>{{cite journal"),
  new Item("header","@book","<ref>{{cite book"),
  new Item("header","@inproceedings","<ref>{{cite conference"),
  new Item("header","@phdthesis","<ref>{{cite thesis |type=PhD"),
  new Item("header","@techreport","<ref>{{cite techreport"),
  new Item("header","@incollection","<ref>{{Citation"),
  
  new Item("field","url","url"),
  new Item("field","booktitle","conference"),
  new Item("field","title","title"),
  new Item("field","author","author"),
  new Item("field","journal","journal"),
  new Item("field","pages","pages"),
  new Item("field","year","year"),
  new Item("field","publisher","publisher"),
  new Item("field","organization","publisher"),
  new Item("field","school","publisher"),
  new Item("field","volume","volume"),
  new Item("field","institution","institution"),
  new Item("field","number","number"),
  new Item("field","doi","doi"),
  new Item("footer","}\n","}}</ref>\n\n"),
];
var dict = {
  "inputstring": "",
  "markupid": -1,
  "bibtex": "",
  "outputstring": "",
}
function stripline(text,leftsymbol,rightsymbol) {
  // extract text between characters
  var p1=text.indexOf(leftsymbol)+1
  var p2=text.indexOf(rightsymbol)
  return text.substring(p1,p2)
}

function setmarkupid(str) {
  // searches for str in item
  result=-1
  if(str.length==1) { // footer
    str+="\n"
  }
  for (var i=0;i<item.length;i++) { 
    if(str.indexOf(item[i].bibtex)!=-1) { // near match
      result=i
      break
    }
  }
  dict["inputstring"]= str
  dict["markupid"]= result
  if (result==-1) { 
    dict["bibtex"]="notfound"
    dict["outputstring"]=""
  }
  else { dict["bibtex"]= item[result].bibtex }
}
function parseline() {
  // bibtext to mediawiki
  var result=""
  var markupid=dict["markupid"]
  var wikisyntax=item[markupid].wikisyntax
  var type=item[markupid].type
  if(type=="header" || type=="footer") {
    result=wikisyntax
  }
  else if(type=="field") {
    // regex help: /g = global |=or $=last character
    var temp=dict["inputstring"]
    temp = temp.replace(dict["bibtex"],"") // remove bibtex name
    temp = temp.replace(/=|{|}|,$/g,"") // remove special characters: { } ,
    temp = temp.replace(/^\s+/g,"") // remove leading whitespaces
    result+=" |"+wikisyntax+"="+temp
  }
  dict["outputstring"]=result
}
function buttonconvert() {
  document.getElementById('outputbox').value = ""
  var lines=document.getElementById("inputbox").value.split("\n")
  for (var i=0;i<lines.length;i++) { 
    setmarkupid(lines[i])
    if (dict["markupid"]!=-1) {
      parseline()
    }
    document.getElementById('outputbox').value +=dict["outputstring"] 
  }
}
function buttondebug() {
  var i=document.getElementById('debugline').value
  var lines=document.getElementById("inputbox").value.split("\n")
  setmarkupid(lines[i])
  if (dict["markupid"]!=-1) {
    parseline()
  }
  var text="debug mode for line "+i
  text+="\n-----------------------\n"
  text+="inputstring: "+dict["inputstring"]+"\n"
  text+="markupid: "+dict["markupid"]+"\n"
  text+="markupname: "+dict["bibtex"]+"\n"
  text+="outputstring: "+dict["outputstring"]+"\n"
  document.getElementById('outputbox').value =text
}
  
function buttonreset() {
  // version info
  document.getElementById('labelversion').innerHTML = "version "+version
  // default bibtex input
  var text = `@article{lastname2019,
  title = {The title of the article},
  author = {firstname lastname},
  journal={name of the academic journal},
  pages= {20--30},
  volume= {4},
  doi = {15.119/ia.2019.654398},
  year= {2019},
}
  ` // <----------- end multiline string
  document.getElementById('inputbox').value = text
  buttonconvert()
}

</script>
</head>

<body>
<h3>BibTeX to MediaWiki converter</h3>
<form name="form1">
  <label id="labelversion"></label><br>
  <p>
  <textarea id="inputbox" cols="62" rows="15"> </textarea><textarea id="outputbox" cols="62" rows="15"></textarea>
  <p>
  <input type="button" name="submit" value="convert" onclick="buttonconvert();" />
  <input type="button" name="submit" value="reset" onclick="buttonreset();" />
  <p><p>
  line <input type="text" value="0" id="debugline" size="4"/> <input type="button" name="submit" value="debug" onclick="buttondebug();" />
</form>  

</body>
</html>

<script language="javascript" type="text/javascript">
  buttonreset()
</script>
